#!/bin/ash

# Do not edit this file, use ip-up.local instead.

# (C) 1997-2004 SuSE Linux AG, Nuernberg, Germany
# Klaus Franken 25.02.1998
# Remo Behn 18.07.1998
# Arvin Schnell 28.02.2002
# Ludwig Nussel 26.02.2004
# Send suggestions and comments to http://www.suse.de/feedback/

BASENAME=${0##*/}
INTERFACE=$1
DEVICE=$2
SPEED=$3
LOCALIP=$4
REMOTEIP=$5
IPPARAM=$6



PID_FILE="/var/wan/pid"
IF_CONFIG="/var/wan/$INTERFACE/config"
IF_MNT_CONFIG="/mnt/jffs2/wan/$DEVICE/config"
IF_MNT_MAC="/mnt/jffs2/wan/$DEVICE/mac"
IF_STATUS="/var/wan/$INTERFACE/status"
PARA_FILE="/var/wan/flag"

# get wan process id
pid=
get_pid()
{
	read pid < $PID_FILE
}

# write bbsp flag, the flag identify the wan status change 
write_flag()
{
    if [ -n "$PPPD_EM" ] 
    then 
	echo 3 > $PARA_FILE
    else
	echo 1 > $PARA_FILE
    fi
}

# send signal to notify the change of wan status 
send_sig()
{		
    if [ "$PPPD_PID" = "0" ]
    then
        echo "Get pppd pid failed during running ip-up script!" > $IF_CONFIG
    else
        kill -23 $PPPD_PID 
        fi	
}

# write ipcp info to config file 
write_config()
{
	echo > $IF_CONFIG
	[ -n "$IPLOCAL" ] && echo ip= $IPLOCAL >> $IF_CONFIG
	[ -n "$IPREMOTE" ] && echo router= $IPREMOTE >> $IF_CONFIG
	[ -n "$PPP_PEER_MAC" ] && echo ppp_peer_mac= $PPP_PEER_MAC >> $IF_CONFIG
	[ -n "$DNS1" -o -n "$DNS2" ] && echo dns= $DNS1 $DNS2 >> $IF_CONFIG
	echo mask= 32 >> $IF_CONFIG
	echo sessionid= $SESSIONID >> $IF_CONFIG
	echo mtu= $MTU >> $IF_CONFIG
	[ -n "$PPPOE_ACNAME" ] && echo pppoe_acname= $PPPOE_ACNAME >> $IF_CONFIG
	
	if [ "$SENDPADTFLAG" == "1" ]                                                                                                         
     then                                                                                                                       
     echo $SESSIONID > $IF_MNT_CONFIG                                                                                           
     echo $PPP_PEER_MAC > $IF_MNT_MAC                                                                                           
     fi 
	
}

# clear config file 
clear_config()
{
	echo > $IF_CONFIG
}

# change status
connect=3
set_connect()
{
	echo $connect > $IF_STATUS
}

#########
case "$BASENAME" in
    ip-up)
	write_config	
	send_sig
	;;
esac
